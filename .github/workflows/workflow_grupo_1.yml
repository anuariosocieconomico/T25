name: Scripts Grupo 1

on:
  schedule:
    # Executa todo dia 1 do m√™s √†s 00:00 America/Maceio (UTC-3) = 03:00 UTC
    - cron: "0 3 1 * *"
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  run-script-1:
    runs-on: windows-latest
    env:
      DADOS_ABERTOS_API: ${{ secrets.DADOS_ABERTOS_API }}
      CAGED_LOGIN: ${{ secrets.CAGED_LOGIN }}
      CAGED_PASSWORD: ${{ secrets.CAGED_PASSWORD }}
      GOOGLE_DRIVE_API_KEY: ${{ secrets.GOOGLE_DRIVE_API_KEY }}
      OUTLOOK_EMAIL: ${{ secrets.OUTLOOK_EMAIL }}
      OUTLOOK_PASSWORD: ${{ secrets.OUTLOOK_PASSWORD }}
      NOTIFICATION_EMAIL: ${{ secrets.NOTIFICATION_EMAIL }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main # Faz checkout direto da branch de desenvolvimento

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10.11'
          cache: 'pip'
          cache-dependency-path: 'Scripts/Daniel/requirements.txt'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r Scripts/Daniel/requirements.txt

      - name: Check for existing PR
        id: check_pr
        run: |
          $prs = gh pr list --base main --head feature/atualizacao-grupo-1 --json number,url --jq '.[0]'
          if ($prs) {
            $prNumber = ($prs | ConvertFrom-Json).number
            $prUrl = ($prs | ConvertFrom-Json).url
            echo "pr_exists=true" >> $env:GITHUB_OUTPUT
            echo "pr_number=$prNumber" >> $env:GITHUB_OUTPUT
            echo "pr_url=$prUrl" >> $env:GITHUB_OUTPUT
            Write-Host "PR #$prNumber j√° existe e ser√° atualizado"
          } else {
            echo "pr_exists=false" >> $env:GITHUB_OUTPUT
            Write-Host "Nenhum PR existente. Um novo ser√° criado."
          }
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Run Script 1
        run: python Scripts/Daniel/1_GRUPO_SCRIPTS.py

      - name: Create or Update Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Script 1 - atualiza√ß√£o autom√°tica de dados (Execu√ß√£o: ${{ github.run_number }})"
          branch: feature/atualizacao-grupo-1
          delete-branch: true
          base: main
          title: "Atualiza√ß√£o autom√°tica - Script Grupo 1"
          body: |
            ## Atualiza√ß√£o Autom√°tica de Dados
            
            ‚ö†Ô∏è **Este PR √© atualizado automaticamente todo dia 1 do m√™s**
            
            As altera√ß√µes foram geradas pela execu√ß√£o do script `1_GRUPO_SCRIPTS.py`.
            
            ### Informa√ß√µes da Execu√ß√£o
            - **Executado em:** ${{ github.event_name }}
            - **Data/Hora:** ${{ github.event.repository.updated_at }}
            - **Run ID:** ${{ github.run_id }}
            - **Run Number:** ${{ github.run_number }}
            - **Workflow:** [Ver execu√ß√£o](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            ### Status
            ${{ steps.check_pr.outputs.pr_exists == 'true' && 'üîÑ **PR Atualizado** - Este PR j√° existia e foi atualizado com novos dados.' || '‚ú® **Novo PR** - Este √© um novo Pull Request.' }}
            
            ---
            üí° **Nota:** Se houver m√∫ltiplos commits, revise o hist√≥rico para ver todas as atualiza√ß√µes.
          labels: |
            automated-pr
            data-update

      - name: Send Email Notification - PR Created
        if: steps.cpr.outputs.pull-request-number && steps.check_pr.outputs.pr_exists == 'false'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp-mail.outlook.com
          server_port: 587
          secure: true
          username: ${{ secrets.OUTLOOK_EMAIL }}
          password: ${{ secrets.OUTLOOK_PASSWORD }}
          subject: "‚ú® Novo PR - Script Grupo 1 (Run #${{ github.run_number }})"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.OUTLOOK_EMAIL }}
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background-color: #0366d6; color: white; padding: 20px; border-radius: 5px 5px 0 0; }
                .content { background-color: #f6f8fa; padding: 20px; border-radius: 0 0 5px 5px; }
                .info-box { background-color: white; padding: 15px; margin: 10px 0; border-left: 4px solid #0366d6; }
                .button { display: inline-block; padding: 10px 20px; background-color: #0366d6; color: white; text-decoration: none; border-radius: 5px; margin: 10px 0; }
                .footer { margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header">
                  <h2>‚ú® Novo Pull Request Criado</h2>
                </div>
                <div class="content">
                  <p>Um novo Pull Request foi criado automaticamente pelo workflow <strong>Scripts Grupo 1</strong>.</p>
                  
                  <div class="info-box">
                    <h3>Informa√ß√µes do PR</h3>
                    <ul>
                      <li><strong>N√∫mero:</strong> #${{ steps.cpr.outputs.pull-request-number }}</li>
                      <li><strong>Branch:</strong> feature/atualizacao-grupo-1</li>
                      <li><strong>Base:</strong> main</li>
                      <li><strong>Data/Hora:</strong> ${{ github.event.repository.updated_at }}</li>
                      <li><strong>Run ID:</strong> ${{ github.run_id }}</li>
                    </ul>
                  </div>
                  
                  <p>
                    <a href="${{ steps.cpr.outputs.pull-request-url }}" class="button">
                      Ver Pull Request
                    </a>
                  </p>
                  
                  <p>
                    <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">
                      Ver execu√ß√£o do workflow
                    </a>
                  </p>
                  
                  <div class="footer">
                    <p>Este √© um email autom√°tico gerado pelo GitHub Actions.</p>
                    <p>Reposit√≥rio: ${{ github.repository }}</p>
                  </div>
                </div>
              </div>
            </body>
            </html>

      - name: Send Email Notification - PR Updated
        if: steps.cpr.outputs.pull-request-number && steps.check_pr.outputs.pr_exists == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp-mail.outlook.com
          server_port: 587
          secure: true
          username: ${{ secrets.OUTLOOK_EMAIL }}
          password: ${{ secrets.OUTLOOK_PASSWORD }}
          subject: "üîÑ PR Atualizado - Script Grupo 1 (Run #${{ github.run_number }})"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.OUTLOOK_EMAIL }}
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background-color: #f39c12; color: white; padding: 20px; border-radius: 5px 5px 0 0; }
                .content { background-color: #f6f8fa; padding: 20px; border-radius: 0 0 5px 5px; }
                .info-box { background-color: white; padding: 15px; margin: 10px 0; border-left: 4px solid #f39c12; }
                .warning-box { background-color: #fff3cd; border: 1px solid #ffc107; padding: 15px; margin: 10px 0; border-radius: 5px; }
                .button { display: inline-block; padding: 10px 20px; background-color: #f39c12; color: white; text-decoration: none; border-radius: 5px; margin: 10px 0; }
                .footer { margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header">
                  <h2>üîÑ Pull Request Atualizado</h2>
                </div>
                <div class="content">
                  <div class="warning-box">
                    <strong>‚ö†Ô∏è Aten√ß√£o:</strong> O PR #${{ steps.check_pr.outputs.pr_number }} j√° existia e foi atualizado com novos dados.
                  </div>
                  
                  <p>O Pull Request existente foi atualizado automaticamente pelo workflow <strong>Scripts Grupo 1</strong>.</p>
                  
                  <div class="info-box">
                    <h3>Informa√ß√µes do PR</h3>
                    <ul>
                      <li><strong>N√∫mero:</strong> #${{ steps.cpr.outputs.pull-request-number }}</li>
                      <li><strong>Branch:</strong> feature/atualizacao-grupo-1</li>
                      <li><strong>Base:</strong> main</li>
                      <li><strong>Data da Atualiza√ß√£o:</strong> ${{ github.event.repository.updated_at }}</li>
                      <li><strong>Run ID:</strong> ${{ github.run_id }}</li>
                      <li><strong>Execu√ß√£o:</strong> #${{ github.run_number }}</li>
                    </ul>
                  </div>
                  
                  <p><strong>üí° Lembre-se:</strong> Revise e aprove o PR para que ele n√£o seja atualizado novamente na pr√≥xima execu√ß√£o.</p>
                  
                  <p>
                    <a href="${{ steps.cpr.outputs.pull-request-url }}" class="button">
                      Ver Pull Request
                    </a>
                  </p>
                  
                  <p>
                    <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">
                      Ver execu√ß√£o do workflow
                    </a>
                  </p>
                  
                  <div class="footer">
                    <p>Este √© um email autom√°tico gerado pelo GitHub Actions.</p>
                    <p>Reposit√≥rio: ${{ github.repository }}</p>
                  </div>
                </div>
              </div>
            </body>
            </html>

      - name: Send Email Notification - Failure
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp-mail.outlook.com
          server_port: 587
          secure: true
          username: ${{ secrets.OUTLOOK_EMAIL }}
          password: ${{ secrets.OUTLOOK_PASSWORD }}
          subject: "‚ùå Falha no Workflow - Script Grupo 1 (Run #${{ github.run_number }})"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: ${{ secrets.OUTLOOK_EMAIL }}
          html_body: |
            <!DOCTYPE html>
            <html>
            <head>
              <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background-color: #d73a49; color: white; padding: 20px; border-radius: 5px 5px 0 0; }
                .content { background-color: #f6f8fa; padding: 20px; border-radius: 0 0 5px 5px; }
                .error-box { background-color: #ffdce0; border: 1px solid #d73a49; padding: 15px; margin: 10px 0; border-radius: 5px; }
                .button { display: inline-block; padding: 10px 20px; background-color: #d73a49; color: white; text-decoration: none; border-radius: 5px; margin: 10px 0; }
                .footer { margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd; font-size: 12px; color: #666; }
              </style>
            </head>
            <body>
              <div class="container">
                <div class="header">
                  <h2>‚ùå Falha na Execu√ß√£o do Workflow</h2>
                </div>
                <div class="content">
                  <div class="error-box">
                    <strong>‚ö†Ô∏è Erro:</strong> O workflow <strong>Scripts Grupo 1</strong> falhou durante a execu√ß√£o.
                  </div>
                  
                  <p>Verifique os logs para identificar o problema.</p>
                  
                  <ul>
                    <li><strong>Reposit√≥rio:</strong> ${{ github.repository }}</li>
                    <li><strong>Branch:</strong> ${{ github.ref }}</li>
                    <li><strong>Run ID:</strong> ${{ github.run_id }}</li>
                    <li><strong>Data/Hora:</strong> ${{ github.event.repository.updated_at }}</li>
                  </ul>
                  
                  <p>
                    <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}" class="button">
                      Ver Logs do Workflow
                    </a>
                  </p>
                  
                  <div class="footer">
                    <p>Este √© um email autom√°tico gerado pelo GitHub Actions.</p>
                  </div>
                </div>
              </div>
            </body>
            </html>